name: Keep Render App Alive

on:
  schedule:
    # Ping every 10 minutes to prevent cold starts
    # Format: minute hour day month day-of-week
    - cron: '*/10 * * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Ping Budget App
        run: |
          echo "ğŸš€ Pinging Budget App to prevent cold start..."
          echo "â° Current time: $(date -u)"
          
          # Your actual Render URL
          APP_URL="https://budget-planner-app-fj6j.onrender.com/health"
          echo "ğŸ¯ Target URL: $APP_URL"
          
          # Ping the health endpoint with detailed output
          echo "ğŸ“¡ Making request..."
          response=$(curl -s -w "HTTPSTATUS:%{http_code};TIME:%{time_total}" --max-time 60 --retry 2 --retry-delay 5 "$APP_URL")
          
          # Extract HTTP status and response time
          http_status=$(echo "$response" | grep -o "HTTPSTATUS:[0-9]*" | cut -d: -f2)
          time_total=$(echo "$response" | grep -o "TIME:[0-9.]*" | cut -d: -f2)
          response_body=$(echo "$response" | sed 's/HTTPSTATUS:[0-9]*;TIME:[0-9.]*$//')
          
          echo "ğŸ“Š Response details:"
          echo "   â€¢ HTTP Status: $http_status"
          echo "   â€¢ Response Time: ${time_total}s"
          echo "   â€¢ Response Body: $response_body"
          
          if [ "$http_status" -eq 200 ]; then
            echo "âœ… App is healthy and responding"
          else
            echo "âŒ App health check failed with status: $http_status"
            echo "ğŸ” Full curl output for debugging:"
            curl -v --max-time 60 "$APP_URL" || true
            exit 1
          fi
          
          echo "ğŸ“Š Keep-alive ping completed successfully"

      - name: Log Status
        if: always()
        run: |
          echo "ğŸ¯ Budget App Keep-Alive Status:"
          echo "   â€¢ Time: $(date -u) UTC"
          echo "   â€¢ Action: Prevent cold start"
          echo "   â€¢ Frequency: Every 10 minutes"
          echo "   â€¢ Cost: Free (GitHub Actions)"
          echo "   â€¢ Workflow: ${{ github.workflow }}"
          echo "   â€¢ Run ID: ${{ github.run_id }}"
